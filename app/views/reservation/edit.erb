<%
@document[:title] = "Edit Reservation ##{@allocation.id}"
content_for :head do
%>
  <script type="text/javascript">
    $( function () {
      var roles = {}
      var role_data = <%=
        @allocation.roles.reduce({}) do |memo, role|
          memo[role.type] = {
            type: role.type,
            person: role.person.values,
            residential_contact: role.residential_contact.values,
            mailing_contact: (role.mailing_contact) ? role.mailing_contact.values : {}
          }
          memo
        end.to_json
      %>
      
      _.each({reservee: 'Reservee', applicant: 'Applicant', next_of_kin: 'Next of Kin'}, function (name, type) {
        var model = null
        if(role_data[type]) {
          model = new Ts.Role({
            type: type,
            person: new Ts.Person(role_data[type].person),
            residential_contact: new Ts.Contact(role_data[type].residential_contact),
            mailing_contact: new Ts.Contact(role_data[type].mailing_contact)
          })
        }
        roles[type] = new Ts.FormViews.RoleBlock({role_type: type, role_name: name, model: model, el: $('#'+type+'_section')})
      })
      _.each(roles, function (role) { role.render() })
      
      $('#places_section label').each( function (idx, element) {
        new Ts.FormViews.PlacesView({el: element})
      })
      
      var multibutton = new Ts.FormViews.Multibutton({name: 'submit', values: {active: 'Submit', completed: 'Complete'}})
      $('#actions_section > div').append(multibutton.render().el)
      
      new Ts.FormViews.AllocationForm({el: $('#reservation_form')[0], roles: roles})
      
      
      
      var roles = []
      for (var type in ['reservee', 'applicant', 'next_of_kin']) {
        if(roleData[type]) {
          roles.push(new Ts.Role({
            type: type,
            person: new Ts.Person(roleData[type].person),
            residential_contact: new Ts.Contact(roleData[type].residential_contact),
            mailing_contact: new Ts.Contact(roleData[type].mailing_contact)
          }))
        } else {
          roles.push(new Ts.Role({type: roleType}))
        }
      }

      new Ts.FormViews.AllocationForm({
        el: $('#reservation_form')[0],
        roles: ['reservee', 'applicant', 'next_of_kin'],
        roleData: $('json\\:roles').parseJSON() || {},
        placeData: $('json\\:places').parseJSON() || [],
        mutlibutton: new Ts.FormViews.Multibutton({name: 'submit', values: {active: 'Submit', completed: 'Complete'}})
      })
    })
  </script>
<% end %>
<%= partial 'reservation/form'%>