<%
@document[:title] = 'Find'
content_for :head do %>
  <script type="text/javascript">
    $( function () {
      $('#search_results .clickable').click( function (e) {
        if(e.target.tagName != 'A') {
          $(this).children('.details').slideToggle(150)
          <!--
          if($(this).hasClass('expanded')) {
            $(this).removeClass('expanded')
            $(this).attr('title', 'Click to expand')
          } else {
            $(this).addClass('expanded')
            $(this).attr('title', 'Click to collapse')
          }
          -->
        }
      }).attr('title', 'Click to expand')
    })
  </script>
<% end %>
<div>
  <section id="search_defintion">
    <h2 class="underline">Find</h2>
    <form class="inline_layout spaced h_padded" method="GET" action".">
      <label style="width: 68%">
        <input class="tooltip" type="text" name="search" placeholder="Search terms..." style="width: 100%"
        title="Valid search fields include: <%= Tombstone::Search.searchable.keys.join(', ') %>. Dates must be in the format dd/mm/yyyy. Dates support less than (<) and greater than (>) operators, e.g. dob>15/04/1960." />
      </label>
      <label style="width: 20%">
        <select type="text" name="type" style="width: 100%">
          <option value="allocations">Find Allocations</option>
        </select>
      </label>
      <label style="text-align: right; width: 12%">
        <input type="submit" class="action_button" value="Search" style="width: 100%;" />
      </label>
    </form>
  </section>
  <section id="search_results">
    <h3 class="underline">
      Results
      <div class="heading_float order_options">
        Order By:
        <%
        base = URI(url('find'))
        Tombstone::Search.sortable.each do |k,v|
          k = k.to_s
          order_dir = (params['order_by'] == k && params['order_dir'] == 'asc') ? 'desc' : 'asc'
          %>
          <a class="<%= params['order_by'] == k ? params['order_dir'] : '' %>" href="<%= base.query = URI.encode_www_form(params.merge('order_by' => k, 'order_dir' => order_dir)); base.to_s %>"><%= k.demodulize.titleize %></a>
          <%
        end
        %>
      </div>
    </h3>
    <div class="list_rows padded">
    <%=
    if @records.length == 0
      "No records found."
    else
      case @records[0]
      when Tombstone::Allocation
        partial 'find/allocation_records', :locals => {records: @records}
      when Tombstone::Person
        partial 'find/person_records', :locals => {records: @records}
      when Tombstone::Place
        partial 'find/place_records', :locals => {records: @records}
      else
        halt 500, "No view has been configured for the model class `#{@records[0].class}`"
      end
    end
    %>
  </section>
</div>
